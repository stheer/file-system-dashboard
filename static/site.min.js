var savedQuery,searchFilters=0,lastInput="",selectedFilters=[],CLIENT_ID=config.CLIENT_ID,API_KEY=config.API_KEY,DISCOVERY_DOCS=["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],SCOPES="https://www.googleapis.com/auth/drive",parentFolder=" and 'shared-drives' in parents and '0AF0hsatILwu6Uk9PVA' in parents",FOLDER_ID="0AF0hsatILwu6Uk9PVA",SHARED_DRIVE="DC Office Drive",SHARED_DRIVE_ID="",fileNum=500,currentFolder="",currentFile="",removedFlag=!0,subFolderArray=[],parentArray=[],parentArrayIDs=[],clickedFolders=[],poppedFolders=[0],fileCounter=0,fileClicked=!1,exportDict={"application/vnd.google-apps.spreadsheet":"application/x-vnd.oasis.opendocument.spreadsheet","application/vnd.google-apps.document":"application/vnd.oasis.opendocument.text","application/msword":"application/vnd.oasis.opendocument.text","application/vnd.openxmlformats-officedocument.wordprocessingml.document":"application/vnd.openxmlformats-officedocument.wordprocessingml.document","text/html":"text/plain","image/jpeg":"image/jpeg","image/png":"image/png","application/pdf":"application/pdf","application/vnd.ms-excel":"application/x-vnd.oasis.opendocument.spreadsheet","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.google-apps.shortcut":"application/x-vnd.oasis.opendocument.spreadsheet"},permissionBuckets=["Public","Team","Admin"],userPermission="",subFolderArrayPermissions=[],filePermissions=[],parentFoldersID=[],parentFoldersNames=[],searchCount=0;function create2DArray(e){for(var s=[],r=0;r<e;r++)s[r]=[];return s}function fileType(e){var s="other";return e.search("google-apps.document")>0||"application/msword"==e?s=".doc":"application/vnd.openxmlformats-officedocument.wordprocessingml.document"==e?s=".docx":e.search("spreadsheet")>0?s=".xlsx":e.search("spreadsheet")>0?s=".csv":e.search("google-apps.form")>0?s="google form":"application/pdf"==e?s=".pdf":e.search("presentation")>0?s=".pptx":"video/quicktime"==e?s=".mov":"image/jpeg"==e?s=".jpg":e.search("folder")>0&&(s="folder"),s}function removeLast(e,s){return e.splice(e.length-s,e.length),e}function handleClientLoad(){gapi.load("client:auth2",initClient)}function initClient(){gapi.client.init({apiKey:API_KEY,clientId:CLIENT_ID,discoveryDocs:DISCOVERY_DOCS,scope:SCOPES}).then((function(){gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus),updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get()),document.getElementById("login_button").onclick=handleAuthClick,document.getElementById("signout_button").onclick=handleSignoutClick}),(function(e){alert("Sign-in Error: "+e)}))}function updateSigninStatus(e,s){if(e){document.getElementById("login_button").style.display="none",document.getElementById("signout_button").style.display="inline-block",googleUser=gapi.auth2.getAuthInstance().currentUser.get();gapi.auth.getToken();var r=googleUser.getAuthResponse().id_token;$.ajax("https://oauth2.googleapis.com/tokeninfo?id_token="+r,{type:"GET",success:function(e){$.ajax({type:"POST",url:"/validate",data:JSON.stringify({aud:e.aud,email:e.email,name:e.name}),dataType:"json",contentType:"application/json; charset=utf-8",success:function(e){restrictAccess(userPermission=e.permission)},error:function(e){alert("Could not query user permissions!")}})}}),$("#folder-select").prop("disabled",!1),gapi.client.drive.drives.list({}).execute((function(e){if(e.error)alert("Cannot Load Drives!");else{for(var s=e.result.drives,r=0;r<s.length;r++)s[r].name==SHARED_DRIVE&&(SHARED_DRIVE_ID=s[r].id);""==SHARED_DRIVE_ID&&(alert("Cannot access database! Please Either: \n \t1) Request shared drive access\n \tor\n \t2) Update 'Shared Drive Name' in Preferences"),$("#folder-select").attr("disabled",!0))}}))}else $("#settings-button").hide(),$("#folder-select").prop("disabled",!0),document.getElementById("login_button").style.display="inline-block",document.getElementById("signout_button").style.display="none"}function handleAuthClick(e){gapi.auth2.getAuthInstance().signIn()}function restrictAccess(e){"Admin"==e?$("#settings-button").show():"Public"==e&&($("#create-folder").hide(),$("#upload-file").hide())}function handleSignoutClick(e){$("#file-div").hide(),$("#file-options-buttons").hide(),$("#search-bottom").hide(),$("#library-bottom").hide(),$("#folder-select").val(""),$("#folder-select").attr("disabled",!0),$("#sub-folder-list").empty(),$("#sub-folder-trash").empty(),$("h4").hide(),$("#sub-folder-table").hide(),$("#settings-button").hide(),window.location.href.includes("/settings")&&(window.location.href="/"),gapi.auth2.getAuthInstance().signOut()}function appendPre(e){var s=document.createTextNode(e+"\n");pre.appendChild(s)}function noFilesMessage(){$(".file-header").hide(),$(".list").empty(),$("#file-list").html("<br><br><br>No files...")}function showSuccessAndEmpty(e){var s,r=e.charAt(0).toUpperCase()+e.slice(1);("folder"==e||"file"==e?($("#"+e+"-form").hide(),$("#success-message").append(r+" Succesfully Created!"),$("#close-"+e).prop("disabled",!1)):"files"==e?($("#file-form").hide(),$("#success-message").append(r+" Succesfully Created!"),$("#close-file").prop("disabled",!1)):"trash"==e?($("#trash-files").hide(),$("#success-message").append("Files Removed!")):($("#delete-folder").hide(),$("#success-message").append("Folder Removed!")),$("#success-message").show(),setTimeout((function(){$("#success-message").hide(),$("#success-message").empty(),$("#folder-name").val(""),$("#file-form").val("")}),2e3),$("#file-table").hide(),"trash"==e||"file"==e||"files"==e)?(s="Search"==$("#folder-select").val()?savedQuery:null,listFiles(currentFolder,null,!1,s)):setTimeout((function(){$("#folder-select").trigger("change")}),1e3);$("#file-table").show()}function showSuccessAndUpdateUser(e){"trash"==e?($("#user-success-message").append("User Removed!"),$("#trash-users").hide()):"add"==e&&($("#user-success-message").append("User Added!"),$("#new-user-name").val(""),$("#new-user-permission").val("")),$("#user-success-message").show(),setTimeout((function(){$("#user-success-message").hide(),$("#user-success-message").empty(),loadUsers()}),2e3)}function folderPermissionWrapper(e){return getFolderPermission(e).then()}function getFolderPermission(e){return new Promise((s,r)=>{$.ajax({type:"POST",url:"/findPermission",data:JSON.stringify({folder_id:e.id}),dataType:"json",contentType:"application/json; charset=utf-8",success:function(e){subFolderArrayPermissions.push(e.permission),s("success")},error:function(e){console.log(e),subFolderArrayPermissions.push(null),r("error")}})})}function getFileParents(e){var s=gapi.auth.getToken().access_token;return new Promise((r,i)=>{gapi.client.request({path:"https://www.googleapis.com/drive/v3/files/"+e.id,headers:{Authorization:"Bearer "+s},params:{supportsAllDrives:!0,fields:"parents"}}).execute((function(s){if(s.error)console.log("Cant access parent of "+e.id),filePermissions.push(null),i("error");else{var l=s.parents[0];parentFoldersID.push(l),$.ajax({type:"POST",url:"/findPermission",data:JSON.stringify({folder_id:l}),dataType:"json",contentType:"application/json; charset=utf-8",success:async function(e){filePermissions.push(e.permission),await getFolderName(l),r("success")}})}}))})}function getFolderName(e){var s=gapi.auth.getToken().access_token;return new Promise((r,i)=>{gapi.client.request({path:"https://www.googleapis.com/drive/v3/files/"+e,headers:{Authorization:"Bearer "+s},params:{supportsAllDrives:!0,fields:"name"}}).execute((function(e){e.error?(parentFoldersNames.push(null),i("error")):(parentFoldersNames.push(e.name),r("success"))}))})}function listFiles(e,s,r,i){if(null==i){if($(".loadDisable").attr("disabled",!0),fileCounter=0,null!=s&&clickedFolders.push(s.currentTarget.id.split("-")[1]),0==parentArray.length)var l="trashed=false and mimeType='application/vnd.google-apps.folder' and name='"+e+"'";else l="trashed=false and mimeType='application/vnd.google-apps.folder' and name='"+e+"' and '"+parentArray[parentArray.length-1]+"' in parents";gapi.client.drive.files.list({pageSize:fileNum,q:l,fields:"nextPageToken, files(id)",corpora:"drive",driveId:SHARED_DRIVE_ID,supportsAllDrives:!0,includeItemsFromAllDrives:!0}).execute((function(e){if(e.error)return alert("Error: "+e.error.message),void $(".loadDisable").attr("disabled",!1);var i=e.result.files[0];try{window.FOLDER_ID=i.id}catch(e){if(null!=s)return void setTimeout((function(){$("#folder-select").trigger("change")}),1500)}if(null!=s){let e=permissionBuckets.slice();$.ajax({type:"POST",url:"/findPermission",data:JSON.stringify({folder_id:window.FOLDER_ID}),dataType:"json",contentType:"application/json; charset=utf-8",success:function(r){if("Public"!=userPermission)if(null!=r.permission)e.splice(e.indexOf(r.permission),1),$(s.currentTarget.parentElement).append("\t <select id='"+window.FOLDER_ID+"' class='subFolder-permission loadDisable' disabled><option value='"+r.permission+"' selected>"+r.permission+"</option><option value='"+e[0]+"'>"+e[0]+"</option><option value='"+e[1]+"'>"+e[1]+"</option>");else if(0!=parentArray.length){e.unshift("null");for(var i="\t <select id='"+window.FOLDER_ID+"' class='subFolder-permission loadDisable' disabled><option value='' selected disabled hidden>"+e[0]+"</option>",l=1;l<e.length;l++)i=i+"<option value='"+e[l]+"'>"+e[l]+"</option>";$(s.currentTarget.parentElement).append(i)}},error:function(e,s,r){console.log(r)}})}l="trashed=false and '"+window.FOLDER_ID+"' in parents",gapi.client.drive.files.list({pageSize:fileNum,q:l,fields:"nextPageToken, files(id, name, mimeType, modifiedTime)",corpora:"drive",driveId:SHARED_DRIVE_ID,supportsAllDrives:!0,includeItemsFromAllDrives:!0}).execute((async function(e){if(e.error)return alert("Error: "+e.error.message),void $(".loadDisable").attr("disabled",!1);var i=e.result.files,l=!0,t=!0;if(subFolderArray=[],subFolderArrayPermissions=[],i&&i.length>0){$(".list").empty(),$(".file-header").show();for(var a=0;a<i.length;a++){var o=i[a],n=o.name;if((d=o.name.substr(o.name.lastIndexOf("."))).length>1&&d.length<6)n=o.name.replace(d,"");else var d=fileType(o.mimeType);if("folder"==d)t=!1,await folderPermissionWrapper(o),subFolderArray.push(n);else{l=!1,fileCounter++,$("#file-list").append("<button value='"+o.id+"#"+o.mimeType+"' id=file-"+a+" class='file loadDisable'>"+n+"</button>"),$("#type-list").append("<div id=type-"+a+" class=type>"+d+"</div>");var c=new Date(Date.parse(o.modifiedTime));$("#date-list").append("<div id=date-"+a+" class=date>"+c.toLocaleDateString()+"</div>"),"Public"!=userPermission&&$("#delete-list").append("<input type='checkbox' class='trash-box loadDisable' id='box-"+a+"' value='"+o.id+"'>")}}t&null!=s&&($(s.currentTarget).addClass("click-error"),setTimeout((function(){$(s.currentTarget).removeClass("click-error")}),500),poppedFolders.push(clickedFolders.pop())),l&&noFilesMessage()}else noFilesMessage(),null!=s&&(poppedFolders.push(clickedFolders.pop()),$(s.currentTarget).addClass("click-error"),setTimeout((function(){$(s.currentTarget).removeClass("click-error")}),500));return r&&showSubFolders(!1),void $(".loadDisable").attr("disabled",!1)}))}))}else{l="trashed=false";for(var t=0;t<i.length;t++)if("Modified Date"==i[t][0])l=l+" and modifiedTime > '"+i[t][1]+"'";else if("File Contents"==i[t][0])l=l+" and fullText contains '"+i[t][1]+"'";else if("Folder"==i[t][0])l=l+" and '"+i[t][1]+"' in parents";else if("File Name"==i[t][0])l=l+" and name contains '"+i[t][1]+"'";else{if("File Type"!=i[t][0])continue;var a=JSON.parse(i[t][1]);for(j=0;j<a.length;j++)0==j&&a.length>1?l=l+" and (mimeType ='"+a[j]+"'":0==j&&1==a.length?l=l+" and mimeType ='"+a[j]+"'":j>0&&j==a.length-1?l=l+" or mimeType ='"+a[j]+"')":j>0&&j<a.length-1&&(l=l+" or mimeType ='"+a[j]+"'")}gapi.client.drive.files.list({pageSize:fileNum,q:l,fields:"nextPageToken, files(id, name, mimeType, modifiedTime)",corpora:"drive",driveId:SHARED_DRIVE_ID,supportsAllDrives:!0,includeItemsFromAllDrives:!0}).execute((async function(e){if(e.error)return alert("Error: "+e.error.message),void $(".loadDisable").attr("disabled",!1);var i=e.result.files,l=!0,t=!0;if(subFolderArray=[],subFolderArrayPermissions=[],filePermissions=[],parentFoldersID=[],parentFoldersNames=[],i&&i.length>0){$(".list").empty(),$(".file-header").show();for(var a=0;a<i.length;a++){var o=i[a],n=o.name;if((d=o.name.substr(o.name.lastIndexOf("."))).length>1&&d.length<6)n=o.name.replace(d,"");else var d=fileType(o.mimeType);if(await getFileParents(o),"folder"==d)t=!1,await folderPermissionWrapper(o),subFolderArray.push(n);else if("Admin"==userPermission||null==filePermissions[a]||"Public"==userPermission&&"Public"==filePermissions[a]||"Team"==userPermission&&"Admin"!=filePermissions[a]){$("#file-list").append("<button value='"+o.id+"#"+o.mimeType+"' id=file-"+a+" class='file loadDisable'>"+n+"</button>"),$("#parent-folder-list").append("<div id=parent-folder-"+a+" class=parent-folder>"+parentFoldersNames[a]+"</div>"),$("#type-list").append("<div id=type-"+a+" class=type>"+d+"</div>");var c=new Date(Date.parse(o.modifiedTime));$("#date-list").append("<div id=date-"+a+" class=date>"+c.toLocaleDateString()+"</div>"),$("#delete-list").append("<input type='checkbox' class='trash-box loadDisable' id='box-"+a+"' value='"+o.id+"'>"),fileCounter++,l=!1}}t&null!=s&&($(s.currentTarget).addClass("click-error"),setTimeout((function(){$(s.currentTarget).removeClass("click-error")}),500),poppedFolders.push(clickedFolders.pop())),l&&noFilesMessage()}else noFilesMessage(),null!=s&&(poppedFolders.push(clickedFolders.pop()),$(s.currentTarget).addClass("click-error"),setTimeout((function(){$(s.currentTarget).removeClass("click-error")}),500));return r&&showSubFolders(!0),void $(".loadDisable").attr("disabled",!1)}))}}function showSubFolders(e){$("#sub-folder-list").hide(),1==e&&($("#sub-folder-list").empty(),$("#sub-folder-trash").empty());for(var s=0;s<subFolderArray.length;s++)("Admin"==userPermission||"Public"==userPermission&&"Public"==subFolderArrayPermissions[s]||"Team"==userPermission&&"Admin"!=subFolderArrayPermissions[s])&&($("#sub-folder-list").append("<div class='subfolder-button-div' id='subfolder-div"+(parentArray.length+1)+s+"'><button value='"+subFolderArray[s]+"' class='sub-folder-link loadDisable' id='link-"+(parentArray.length+1)+s+"' style='margin-left:"+2*(parentArray.length+1)+"%'>/"+subFolderArray[s]+"</button></div>"),"Public"!=userPermission&&$("#sub-folder-trash").append("<input type='checkbox' class='folder-trash-box loadDisable visibility' id='folder-box-"+(parentArray.length+1)+s+"' value='"+subFolderArray[s]+"'>"),parentArrayIDs.push("link-"+(parentArray.length+1)+s));$("#sub-folder-list").show(),$("#sub-folder-table").show(),$("h4").show()}function addFileButtons(e,s,r,i){fileClicked=!0,""!=currentFile&&clickedFileButton(),currentFile=e.currentTarget.id.split("-")[1],$(e.currentTarget).addClass("clicked"),fileCounter>1&&($("#space-entry").append(" <br> "),$("#move-down-file").append($("#file-"+currentFile)),$("#move-down-type").append($("#type-"+currentFile)),$("#move-down-date").append($("#date-"+currentFile)),$("#move-down-delete").append($("#box-"+currentFile)),"Search"==$("#folder-select").val()&&$("#move-down-folder").append($("#parent-folder-"+currentFile))),$(".trash-box").prop("disabled",!0),$(".folder-trash-box").prop("disabled",!0),$("#file-options-preview").prop("value",s),$("#file-options-download").prop("value",r),$("#file-options-edit").prop("value",i),$("#file-options-buttons").show()}function clickedFileButton(){fileCounter>1&&($("#space-entry").empty(),$("#file-list").append($("#file-"+currentFile)),$("#type-list").append($("#type-"+currentFile)),$("#date-list").append($("#date-"+currentFile)),$("#delete-list").append($("#box-"+currentFile)),"Search"==$("#folder-select").val()&&$("#parent-folder-list").append($("#parent-folder-"+currentFile))),$(".file").each((function(){$(this).hasClass("clicked")&&$(this).removeClass("clicked")})),$(".trash-box").prop("disabled",!1),$(".folder-trash-box").prop("disabled",!1),$("#file-options-buttons").hide()}function insertFileIntoFolder(e){var s=gapi.auth.getToken().access_token;gapi.client.request({path:"https://www.googleapis.com/drive/v2/files/"+window.FOLDER_ID+"/children",method:"POST",headers:{Authorization:"Bearer "+s},params:{supportsAllDrives:!0},body:{id:e}}).execute((function(e){e.error&&alert("File Could Not Be Added to Folder!")}))}function updateFileLocation(e){var s=gapi.auth.getToken().access_token;gapi.client.request({path:"https://www.googleapis.com/drive/v2/files/"+e+"?addParents="+window.FOLDER_ID+"?removeParents=root",method:"PUT",headers:{Authorization:"Bearer "+s},params:{supportsAllDrives:!0}}).execute((function(e){e.error&&alert("File Could Not Be Added to Folder!")}))}function addNewUser(e,s){return new Promise((r,i)=>{$.ajax({type:"POST",url:"/addUser",data:JSON.stringify({username:e,permission:s}),dataType:"json",contentType:"application/json; charset=utf-8",success:function(e){console.log(e),r("success")},error:function(e){console.log(e),i("error")}})})}function moveFileToTrash(e){return new Promise((s,r)=>{var i=gapi.auth.getToken().access_token;gapi.client.request({path:"https://www.googleapis.com/drive/v2/files/"+e+"/trash",method:"POST",headers:{Authorization:"Bearer "+i},params:{supportsAllDrives:!0}}).execute((function(e){e.error?(alert("File Could Not Be Removed!"),r("error")):(console.log("file removed"),s("success"))}))})}function moveUserToTrash(e){return new Promise((s,r)=>{$.ajax({type:"POST",url:"/removeUser",data:JSON.stringify({username:e}),dataType:"json",contentType:"application/json; charset=utf-8",success:function(e){console.log(e),s("success")},error:function(e){console.log(e),r("error")}})})}function moveFolderToTrash(e){return new Promise((s,r)=>{if(0==parentArray.length)var i="trashed=false and mimeType='application/vnd.google-apps.folder' and name='"+e+"'";else{var l=parentArray[parentArray.length-1];i="trashed=false and mimeType='application/vnd.google-apps.folder' and name='"+e+"' and '"+l+"' in parents"}gapi.client.drive.files.list({pageSize:fileNum,q:i,fields:"nextPageToken, files(id)",corpora:"drive",driveId:SHARED_DRIVE_ID,supportsAllDrives:!0,includeItemsFromAllDrives:!0}).execute((function(e){if(e.error)alert("Folder Could Not Be Removed!"),r("error");else{var i=e.result.files[0];$.ajax({type:"POST",url:"/deletePermission",data:JSON.stringify({folder_id:i.id}),dataType:"json",contentType:"application/json; charset=utf-8",success:async function(e){console.log(e),await moveFileToTrash(i.id),s("success")},error:function(e){console.log(e),r("error")}})}}))})}function showLoad(){$(".progress").show();var e=new window.XMLHttpRequest;return e.upload.addEventListener("progress",(function(e){if(e.lengthComputable){var s=100*(e.loaded/e.total-1e-4);console.log(s),$("#upload-progress").prop("aria-valuenow",String(s)),$("#upload-progress").prop("style","width: "+String(s)+"%"),$("#upload-progress").html(String(s.toFixed(2))+"%")}}),!1),e}function removeLast(e,s){return e.splice(e.length-s,e.length),e}function uploadFile(e,s){return uploadRequest(e).then()}function uploadRequest(e){return new Promise((s,r)=>{e.size<=0&&(e=new Blob([" "],{type:e.type||"application/octet-stream"})),1==fileClicked&&clickedFileButton();var i=gapi.auth.getToken().access_token,l=new FileReader;l.readAsBinaryString(e),l.onload=function(t){var a={name:e.name,mimeType:e.type||"application/octet-stream",kind:"drive#file",parents:[window.FOLDER_ID]},o=btoa(l.result),n="\r\n--file-upload\r\nContent-Type: application/json; \r\n\r\n"+JSON.stringify(a)+"\r\n--file-upload\r\nContent-Type: "+e.type+"\r\nContent-Transfer-Encoding: base64\r\n\r\n"+o+"\r\n--file-upload--";gapi.client.request({path:"https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",method:"POST",headers:{"Content-Type":'multipart/related; boundary="file-upload"',Authorization:"Bearer "+i},params:{supportsAllDrives:!0},body:n}).execute((function(e){e.error?(alert("Error: "+e.error.message),r("error")):s("success")}))}})}async function fileUploadLoop(){files=$("#file-select").prop("files");for(let s=0;s<files.length;s++){var e=files[s];console.log(e),await uploadFile(e)}$("#success-message").empty(),1==files.length?showSuccessAndEmpty("file"):showSuccessAndEmpty("files")}function checkBlankSearches(){var e=0;$(".search").each((function(){(""==$(this).val()|null==$(this).val())&!$(this).is(":hidden")&&e++})),0==e?$("#execute-query").prop("disabled",!1):$("#execute-query").prop("disabled",!0)}function getAllFolders(e){gapi.client.drive.files.list({pageSize:fileNum,q:"trashed=false and mimeType='application/vnd.google-apps.folder'",fields:"nextPageToken, files(id, name)",corpora:"drive",driveId:SHARED_DRIVE_ID,supportsAllDrives:!0,includeItemsFromAllDrives:!0}).execute((async function(s){if(!s.error){subFolderArrayPermissions=[];for(var r=s.result.files,i=create2DArray(r.length),l=0;l<r.length;l++){var t=r[l];await getFolderPermission(t),("Admin"==userPermission||"Public"==userPermission&&"Public"==subFolderArrayPermissions[l]||"Team"==userPermission&&"Admin"!=subFolderArrayPermissions[l])&&(i[l][0]=t.id,i[l][1]=t.name)}i.sort((function(e,s){return e[1]>s[1]?1:e[1]<s[1]?-1:0}));for(l=0;l<i.length;l++)$("#search"+e).append("<option value='"+i[l][0]+"'>"+i[l][1]+"</option>")}}))}function getAllFileTypes(e){var s,r={};gapi.client.drive.files.list({pageSize:fileNum,q:"trashed=false and mimeType!='application/vnd.google-apps.folder'",fields:"nextPageToken, files(id, name, mimeType)",corpora:"drive",driveId:SHARED_DRIVE_ID,supportsAllDrives:!0,includeItemsFromAllDrives:!0}).execute((function(i){if(!i.error){for(var l=i.result.files,t=0;t<l.length;t++){var a=l[t];if(!((o=a.name.substr(a.name.lastIndexOf(".")).toLowerCase()).length>1&&o.length<6))var o=fileType(a.mimeType);"other"!=o&&(null!=r[o]?((s=r[o]).add(a.mimeType),r[o]=s):(s=new Set).add(a.mimeType),s.add(a.mimeType),r[o]=s)}var n,d=create2DArray(Object.keys(r).length);t=0;for(var c in r){s=r[c],n=Array.from(s),d[t][0]=c;for(var p=0;p<n.length;p++)d[t][p+1]=n[p];t++}d.sort((function(e,s){return e[0]>s[0]?1:e[0]<s[0]?-1:0}));for(t=0;t<d.length;t++)n=(n=d[t]).slice(1),$("#search"+e).append("<option value='"+JSON.stringify(n)+"'>"+d[t][0]+"</option>")}}))}function loadUsers(){$("#users").empty(),$("#permissions").empty(),$("#user-trash").empty(),$.ajax({type:"POST",url:"/getUsers",data:JSON.stringify({user:"all"}),dataType:"json",contentType:"application/json; charset=utf-8",success:function(e){for(var s=0;s<Object.keys(e.user).length;s++)$("#users").append("<div class='user-info' id='username-"+s+"'>"+e.user[s]+"</div>"),$("#permissions").append("<div class='user-info' id='permission-"+s+"'>"+e.permission[s]+"</div>"),$("#user-trash").append("<input type='checkbox' class='trash-box' id='username-trash-"+s+"' value='"+e.user[s]+"'>")},error:function(e){console.log(e)}})}$(document).ready(()=>{$("#home-button").on("click",()=>{window.location.href="/"}),$("#library-button").on("click",()=>{window.location.href="/library"}),$("#notes-button").on("click",()=>{window.location.href="/notes"}),$("#settings-button").on("click",()=>{window.location.href="/settings"}),$("#back-button").on("click",()=>{window.location.href=document.referrer}),"/settings"===top.location.pathname?($("#back-button").show(),$("#settings-button").prop("disabled",!0),loadUsers()):($("#back-button").hide(),"Admin"==userPermission&&$("#settings-button").prop("disabled",!1)),$("#new-user-name").on("input",()=>{null==$("#new-user-permission").val()||$("#trash-users").is(":visible")||$("#add-new-user").prop("disabled",!1)}),$("#new-user-permission").on("input",()=>{""==$("#new-user-name").val()||$("#trash-users").is(":visible")||$("#add-new-user").prop("disabled",!1)}),$("#user-trash").on("change",":checkbox",()=>{0==document.querySelectorAll("input:checked").length?($(".loadDisable").attr("disabled",!1),$("#trash-users").hide()):($(".loadDisable").attr("disabled",!0),$("#trash-users").show())}),$("#trash-users").on("click",()=>{$(".trash-box").each((async function(){this.checked&&await moveUserToTrash(this.value)})),showSuccessAndUpdateUser("trash")}),$("#add-new-user").on("click",async()=>{var e=$("#new-user-name").val(),s=$("#new-user-permission").val();await addNewUser(e,s),showSuccessAndUpdateUser("add")}),$("#create-folder").on("click",()=>{$(".close").click(),$("#folder-form").show()}),$("#upload-file").on("click",()=>{$(".close").click(),$("#file-form").show()}),$(".close").on("click",e=>{$(".close").parent().hide(),$(".input").val(""),$("#folder-permission-select").val(""),$("button.input-button").prop("disabled",!0)}),$("#file-select").on("input",()=>{$("#upload").prop("disabled",!1)}),$("#folder-name").on("input",()=>{null!=$("#folder-permission-select").val()&&$("#add-folder").prop("disabled",!1)}),$("#folder-permission-select").on("input",()=>{""!=$("#folder-name").val()&&$("#add-folder").prop("disabled",!1)}),$("#search-filter-options").on("input",".file-search",e=>{searchFilters<5?($("#add-search-filter").prop("disabled",!1),lastInput=e.currentTarget.value):$("#add-search-filter").prop("disabled",!0)}),$("#add-search-filter").on("click",()=>{if("Modified Date"==lastInput?$("#search-query").append("<input type='date' id='search"+searchFilters+"' class='search hide'>"):"Folder"==lastInput?($("#search-query").append("<select id='search"+searchFilters+"' class='search hide'>"),$("#search"+searchFilters).append("<option value='' selected disabled hidden></option>"),getAllFolders(searchFilters)):"File Type"==lastInput?($("#search-query").append("<select id='search"+searchFilters+"' class='search hide'>"),$("#search"+searchFilters).append("<option value='' selected disabled hidden></option>"),getAllFileTypes(searchFilters)):$("#search-query").append("<input type='text' id='search"+searchFilters+"' class='search hide'>"),$("#search"+searchFilters).prop("placeholder",lastInput),$("#file-search"+searchFilters).attr("disabled",!0),selectedFilters.push(lastInput),$("#search"+searchFilters).css({display:"block","margin-top":"5px"}),$("#search"+searchFilters).show(),searchFilters<4){$("#delete-filter"+searchFilters).remove(),searchFilters++,$("#search-filter-options").append("<div id='search-dropdown"+searchFilters+"' class='search-dropdown additional-filter'></div>"),$("#search-dropdown"+searchFilters).append("<label class='label' for='file-search"+searchFilters+"'>And </label>"),$("#file-search0").clone().attr({id:"file-search"+searchFilters,class:"file-search child-level"}).appendTo("#search-dropdown"+searchFilters),$("#file-search"+searchFilters).attr("disabled",!1);for(var e=0;e<selectedFilters.length;e++)$("#file-search"+searchFilters+" option[value='"+selectedFilters[e]+"']").remove();$("#search-dropdown"+searchFilters).append("<button class='delete-filter' id='delete-filter"+searchFilters+"' value='search-dropdown"+searchFilters+"'>x</button>"),$("#add-search-filter").prop("disabled",!0),checkBlankSearches()}else $("#add-search-filter").attr("disabled",!0)}),$("#search-filter-options").on("click",".delete-filter",e=>{$("#add-search-filter").prop("disabled",!0);var s=e.currentTarget.id,r=searchFilters-1;1==$("#file-search"+s.charAt(s.length-1)).prop("disabled")?(removeLast(selectedFilters,2),$("#search"+searchFilters).remove(),$("#search"+r).remove()):(selectedFilters.pop(),$("#search"+r).remove()),searchFilters--,checkBlankSearches(),searchFilters>0?$("#search-dropdown"+searchFilters).append("<button class='delete-filter' id='delete-filter"+searchFilters+"' value='search-dropdown"+searchFilters+"'>x</button>"):($("#execute-query").prop("disabled",!0),selectedFilters=[]),$("#file-search"+searchFilters).attr("disabled",!1),$("#file-search"+searchFilters).val(""),$("#"+e.currentTarget.value).remove()}),$("#search-filter-text").on("input",".search",()=>{checkBlankSearches()}),$("#execute-query").on("click",()=>{var e=create2DArray(5);$("#query-results-sql").empty(),$("#query-results-sql").append("<span class='SQL-select'>SELECT </span>* <span class='SQL-select'>FROM </span><span class='SQL-db'>google.drive </span><br><span class='SQL-select'>&nbsp &nbspWHERE </span>");let s=0,r=0;$(".search").each((function(){e[s][0]=selectedFilters[s],e[s][1]=$(this).val(),0!=s&&$("#query-results-sql").append("<span class='SQL-select'> &nbsp &nbspAND </span>"),r="Folder"==selectedFilters[s]|"File Type"==selectedFilters[s]?$("#"+this.id+" option:selected").text():$(this).val(),"Modified Date"==selectedFilters[s]?$("#query-results-sql").append("<span class='SQL-filter'>"+selectedFilters[s]+"<span/><span class='SQL-select'> > </span><span class='SQL-value'>"+r+"</span><br>"):"File Name"==selectedFilters[s]?$("#query-results-sql").append("<span class='SQL-filter'>"+selectedFilters[s]+"<span/><span class='SQL-select'> LIKE </span><span class='SQL-value'>"+r+"%</span><br>"):"File Contents"==selectedFilters[s]?$("#query-results-sql").append("<span class='SQL-filter'>"+selectedFilters[s]+"<span/><span class='SQL-select'> LIKE </span><span class='SQL-value'>%"+r+"%</span><br>"):$("#query-results-sql").append("<span class='SQL-filter'>"+selectedFilters[s]+"<span/><span class='SQL-select'> = </span><span class='SQL-value'>"+r+"</span><br>"),s++})),savedQuery=e,clickedFolders=["select","root"],listFiles(null,null,!0,e),$("#file-div").show()}),$("#folder-select").on("change",e=>{var s=$("#folder-select").val();if("Search"==s){$("#library-bottom").hide(),$(".list").empty(),$("#sub-folder-list").empty(),$("#sub-folder-trash").empty(),$("#file-table").append("<h4 id='doc-parent-folder' class='file-header'>Parent Folder</h4>"),$("#file-table").append("<div id='parent-folder-list' class='list'></div>"),$("#file-table").append("<div id='move-down-folder' class='list'></div>"),$("#file-div").hide(),$("#file-table").css({"margin-left":"0px"}),$("#execute-query").prop("disabled",!0),$("#query-results-sql").empty();for(var r=0;r<searchFilters+1;r++)0!=r&&($("#search-dropdown"+r).remove(),$("#search"+r).remove()),$("#search"+r).remove();selectedFilters=[],searchFilters=0,$("#file-search0").prop("disabled",!1),$("#file-search0").val(""),$("#search-bottom").show(),$("#sub-folder-table").hide(),$("#sub-folder-table").css({"margin-left":"0px"}),poppedFolders=[0],removedFlag=!0,parentArray=[],parentArrayIDs=["link-root"]}else $("#search-bottom").hide(),removedFlag=!0,parentArray=[],parentArrayIDs=["link-root"],clickedFolders=[],poppedFolders=[0],currentFolder=$("#folder-select").val(),$(".create-buttons").attr("disabled",!1),1==fileClicked&&clickedFileButton(),$("#sub-folder-list").empty(),$("#sub-folder-trash").empty(),$(".form").hide(),$("#library-bottom").show(),$("#doc-parent-folder").remove(),$("#parent-folder-list").remove(),$("#move-down-folder").remove(),$("#file-table").css({"margin-left":"8%"}),$("#sub-folder-table").css({"margin-left":"8%"}),$("#file-div").show(),$("#folder-header").html("Add "+s+" Sub-Folder"),$("#file-header").html("Upload "+s+" File"),$("#trash-files").hide(),$("#delete-folder").hide(),$("#sub-folder-table").show(),$("h4").show(),$("#sub-folder-list").append("<button value='/' class='sub-folder-link loadDisable clicked' id='link-root'>/</button>"),$("#sub-folder-trash").append("<input type='checkbox' class='visibility' id='folder-box-root' value=''>"),listFiles($("#folder-select").val(),e,!0,null)}),$("#add-folder").on("click",()=>{if(""==$(".input").val())alert("Please enter a folder name");else if(-1!=$(".input").val().indexOf("'"))alert("Please enter a valid folder name");else{1==fileClicked&&clickedFileButton(),$("#add-folder").prop("disabled",!0),$("#close-folder").prop("disabled",!0);var e=gapi.auth.getToken().access_token;gapi.client.request({path:"/drive/v3/files/",method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+e},params:{supportsAllDrives:!0},body:{name:$("#folder-name").val(),mimeType:"application/vnd.google-apps.folder",kind:"drive#file",parents:[window.FOLDER_ID]}}).execute((function(e){e.error?alert("Error: "+e.error.message):$.ajax({type:"POST",url:"/setPermission",data:JSON.stringify({folder_id:e.id,permission:$("#folder-permission-select").val(),folder_name:$("#folder-name").val()}),dataType:"json",contentType:"application/json; charset=utf-8",success:function(e){console.log(e),showSuccessAndEmpty("folder")},error:function(e){console.log(e)}})}))}}),$("#upload").on("click",()=>{$("#upload").prop("disabled",!0),$("#close-file").prop("disabled",!0),fileUploadLoop()}),$("#file-list").on("click",".file",e=>{var s=e.currentTarget.value.split("#")[0],r=gapi.auth.getToken().access_token,i=e.currentTarget.value.split("#")[1],l=gapi.client.request({path:"https://www.googleapis.com/drive/v2/files/"+s+"?mimeType="+i+"?alt=media",headers:{Authorization:"Bearer "+r},params:{supportsAllDrives:!0}});$("#file-options-download").prop("disabled",!1),l.execute((function(s,r){if(s.error)alert("Error: "+s.error.message);else if(0!=s)if(console.log(s),s.webContentLink){var l=s.webContentLink.slice(0,25)+"u/999/"+s.webContentLink.slice(25);addFileButtons(e,s.embedLink,l,s.alternateLink)}else addFileButtons(e,s.embedLink,s.exportLinks[exportDict[i]],s.alternateLink),s.exportLinks[exportDict[i]]||$("#file-options-download").prop("disabled",!0);else console.log("GetFile Error! Raw resp: "+JSON.parse(r))}))}),$("#file-options-buttons").on("click","#file-options-preview",e=>{window.open(e.currentTarget.value,"_blank"),clickedFileButton()}),$("#file-options-buttons").on("click","#file-options-download",e=>{window.open(e.currentTarget.value,"_blank"),clickedFileButton()}),$("#file-options-buttons").on("click","#file-options-edit",e=>{window.open(e.currentTarget.value,"_blank"),clickedFileButton()}),$("#file-options-buttons").on("click","#file-options-close",e=>{clickedFileButton(),fileClicked=!1}),$("#delete-list").on("change",":checkbox",()=>{0==document.querySelectorAll("input:checked").length?($(".trash-box").addClass("loadDisable"),$(".loadDisable").attr("disabled",!1),$(".folder-trash-box").prop("disabled",!1),$("#trash-files").hide()):($(".trash-box").removeClass("loadDisable"),$(".loadDisable").attr("disabled",!0),$(".folder-trash-box").prop("disabled",!0),$("#trash-files").show())}),$("#sub-folder-trash").on("change",":checkbox",()=>{0==document.querySelectorAll("input:checked").length?($(".folder-trash-box").addClass("loadDisable"),$(".loadDisable").attr("disabled",!1),$(".trash-box").prop("disabled",!1),$("#delete-folder").hide()):($(".folder-trash-box").removeClass("loadDisable"),$(".loadDisable").attr("disabled",!0),$(".trash-box").prop("disabled",!0),$("#delete-folder").show())}),$("#trash-files").on("click",()=>{$(".trash-box").each((async function(){this.checked&&await moveFileToTrash(this.value)})),showSuccessAndEmpty("trash"),$(".folder-trash-box").prop("disabled",!0)}),$("#delete-folder").on("click",()=>{$(".folder-trash-box").each((async function(){this.checked&&await moveFolderToTrash(this.value)})),showSuccessAndEmpty("trash-sub-folder")}),$("#sub-folder-list").on("input",".subFolder-permission",e=>{$.ajax({type:"POST",url:"/updatePermission",data:JSON.stringify({folder_id:e.currentTarget.id,permission:e.currentTarget.value,folder_name:$(e.currentTarget).siblings(".sub-folder-link").val()}),dataType:"json",contentType:"application/json; charset=utf-8",success:function(e){console.log(e)},error:function(e){console.log(e)}})}),$("#sub-folder-list").on("click",".sub-folder-link",e=>{"Search"==$("#folder-select").val()?(clickedFolders=["select","root"],showSubFoldersFlag=!1):showSubFoldersFlag=!0;var s=e.currentTarget.value,r=e.currentTarget.id;if(currentFolder=s,1==fileClicked&&clickedFileButton(),"link-root"!=r)if($(".sub-folder-link").each((function(){$(this).hasClass("clicked")&&($(this).removeClass("clicked"),$(this).siblings(".subFolder-permission").remove(),$("#folder-box-"+this.id.split("-")[1]).addClass("visibility"))})),$(e.currentTarget).addClass("clicked"),$("#folder-box-"+r.split("-")[1]).removeClass("visibility"),!clickedFolders.includes(r.split("-")[1])&(!(r.split("-")[1][0]<=clickedFolders[clickedFolders.length-1][0])|"s"==clickedFolders[clickedFolders.length-1][0]))!poppedFolders.includes(r.split("-")[1])&removedFlag&r.split("-")[1][0]!=poppedFolders[poppedFolders.length-1][0]&&parentArray.push(window.FOLDER_ID),listFiles(s,e,!0,null),removedFlag=!0;else if(clickedFolders.includes(r.split("-")[1])){removeLast(parentArray,parentArray.length-r.split("-")[1][0]);for(l=parentArrayIDs.splice(parentArrayIDs.indexOf(r)+1,parentArrayIDs.length).filter(e=>e.split("-")[1][0]>r.split("-")[1][0]&"link-root"!=e),t=0;t<l.length;t++)$("#"+l[t]).remove(),$("#folder-box-"+l[t].split("-")[1]).remove(),index=clickedFolders.indexOf(l[t].split("-")[1]),-1!=index&&clickedFolders.splice(index,1);poppedFolders=[0],listFiles(s,e,!1,null),removeLast(clickedFolders,2),removedFlag=!1}else{removeLast(parentArray,parentArray.length-r.split("-")[1][0]);for(var i=parseInt(r.split("-")[1][0])+1,l=parentArrayIDs.splice(parentArrayIDs.indexOf("link-"+i+"0"),parentArrayIDs.length).filter(e=>e.split("-")[1][0]>r.split("-")[1][0]&"link-root"!=e),t=0;t<l.length;t++)$("#"+l[t]).remove(),$("#folder-box-"+l[t].split("-")[1]).remove(),index=clickedFolders.indexOf(l[t].split("-")[1]),-1!=index&&clickedFolders.splice(index,1);removeLast(clickedFolders,1),poppedFolders=[0],listFiles(s,e,showSubFoldersFlag,null),removedFlag=!0}else $("#folder-select").trigger("change")})});